-------------------------------------------------------FactTransactions

--query

SELECT
    b.BillNbr AS TransactionID,
    b.PatientNbr AS PatientID,
    b.ProviderNbr AS PhysicianID,
    cl.ClinicNbr AS HospitalID,
    cr1.DiagnosisCode AS DiagnosisCodeID,
    cr2.CPTCode AS CPTCodeID,
    cr2.GeneratedDate AS ServiceDate,
    b.BillDate AS PaymentDate,
    cr2.CPTUnits AS CPTUnits,
    b.BillAmount AS BilledAmount,
    b.InsuranceCoverage AS InsurancePayment,
    b.PaymentRecieved AS PatientPayment
FROM
    Billing b
LEFT JOIN
    ClinicLocations cl ON b.Facility = cl.DisplayName
LEFT JOIN
    ClinicalReports cr1 ON b.DiagnosisReportRef = cr1.ReportRefNbr
LEFT JOIN
    ClinicalReports cr2 ON b.ServiceReportRef = cr2.ReportRefNbr;




 ---ddl
CREATE TABLE dp_oltp_healthcare.FactTransactions (
    transactionid int8 NOT NULL,
    patientid int8 ,
    physicianid int8 ,
    hospitalid int8 ,
    diagnosiscodeid varchar(20) ,
    cptcodeid varchar(20) ,
    servicedate date ,
    paymentdate date ,
    cptunits numeric(10, 1) ,
    billedamount numeric(10, 2) ,
    insurancepayment numeric(10, 2) ,
    patientpayment numeric(10, 2) ,
    CONSTRAINT FactTransactions_pkey PRIMARY KEY (transactionid)
);






-------------------------------------------------------DimPatient

--query
SELECT
    p.PatientNbr AS PatientID,
    p.RegistrationDate AS RegistrationDate,
    p.HealthCardNbr AS HealthCardNumber,
    p.FirstName AS FirstName,
    p.LastName AS LastName,
    p.Email AS Email,
    p.Gender AS Gender,
    DATE_PART('year', age(CURRENT_DATE, p.DOB)) AS Age,
    p.DOB AS DOB,
    ps.HeightCms AS "Height(cms)",
    ps.HeightIn AS "Height(In)",
    ps.WeightLbs AS "Weight(Lbs)",
    ps.WeightKgs AS "Weight(Kgs)",
    ps.BloodGroup AS BloodGroup,
    ps.TobaccoUser AS Tobacco,
    ps.AlcoholUser AS Alcohol,
    ps.ExerciseFrequency AS Exercise,
    ps.OnDiet AS Diet,
    ps.Ethnicity AS Ethinicity,
    p.Address1 AS Address1,
    p.Address2 AS Address2,
    p.City AS City,
    p.State AS State,
    p.StateCode AS StateCode,
    p.Zip AS ZipCode,
    p.Region AS Region
FROM
    Patient p
LEFT JOIN
    PatientSurvey ps ON p.PatientNbr = ps.SurveyNbr;




--ddl
CREATE TABLE dp_oltp_healthcare.DimPatient (
    patientid int8 NOT NULL,
    registrationdate date NULL,
    healthcardnumber int8 NULL,
    firstname varchar(100) NULL,
    lastname varchar(100) NULL,
    email varchar(255) NULL,
    gender varchar(10) NULL,
    age int4 NULL,
    dob date NULL,
    heightcms int4 NULL,
    heightin int4 NULL,
    weightlbs numeric(5, 2) NULL,
    weightkgs numeric(5, 2) NULL,
    bloodgroup varchar(10) NULL,
    tobacco varchar(10) NULL,
    alcohol varchar(10) NULL,
    exercise varchar(10) NULL,
    diet varchar(10) NULL,
    ethinicity varchar(50) NULL,
    address1 varchar(255) NULL,
    address2 varchar(255) NULL,
    city varchar(100) NULL,
    state varchar(50) NULL,
    statecode varchar(10) NULL,
    zipcode varchar(10) NULL,
    region varchar(50) NULL,
    CONSTRAINT DimPatient_pkey PRIMARY KEY (patientid)
);


-------------------------------------------------------DimPhysician

--query
SELECT
    pr.ProviderNbr AS ProviderID,
    pr.NpiNbr AS NPI,
    pr.Prefix AS Prefix,
    pr.FirstName AS FirstName,
    pr.LastName AS LastName,
    pr.Email AS Email,
    pr.FTE AS FTE,
    pr.ProviderCategory AS ProviderType,
    ps.SpecialityType AS SpecialityType
FROM
    Provider pr
LEFT JOIN
    ProviderSpecialty ps ON pr.SpecialityCode = ps.SpecialityCode;


--ddl
CREATE TABLE dp_oltp_healthcare.DimPhysician (
    providerid int8 NOT NULL,
    npi int8 NULL,
    prefix varchar(10) NULL,
    firstname varchar(100) NULL,
    lastname varchar(100) NULL,
    email varchar(255) NULL,
    fte numeric(10, 2) NULL,
    providertype varchar(50) NULL,
    specialitytype varchar(100) NULL,
    CONSTRAINT DimPhysician_pkey PRIMARY KEY (providerid)
);


-------------------------------------------------------DimHospital

--query
SELECT
    cl.ClinicNbr AS HospitalID,
    cl.DisplayName AS HospitalName,
    cl.Address1 AS Address1,
    cl.Address2 AS Address2,
    cl.City AS City,
    cl.State AS State,
    cl.Zip AS ZipCode,
    cl.Region AS Region
FROM
    ClinicLocations cl;


--ddl
CREATE TABLE dp_oltp_healthcare.DimHospital (
    hospitalid int8 NOT NULL,
    hospitalname varchar(255) NULL,
    address1 varchar(255) NULL,
    address2 varchar(255) NULL,
    city varchar(100) NULL,
    state varchar(50) NULL,
    zipcode varchar(10) NULL,
    region varchar(50) NULL,
    CONSTRAINT DimHospital_pkey PRIMARY KEY (hospitalid)
);


-------------------------------------------------------DimDiagnosisCode

--query
SELECT
    dcl.DiagnosisCode AS DiagnosisCode,
    dcl.DiagnosisGrouping AS DiagnosisCodeDescription,
    dcl.DiagnosisDescription AS DiagnosisCodeGroup
FROM
    DiagnosisCodeLookup dcl;


--ddl
CREATE TABLE dp_oltp_healthcare.DimDiagnosisCode (
    diagnosiscode varchar(10) NOT NULL,
    diagnosiscodedescription varchar(255) NULL,
    diagnosiscodegroup varchar(255) NULL,
    CONSTRAINT DimDiagnosisCode_pkey PRIMARY KEY (diagnosiscode)
);


-------------------------------------------------------DimCPTCode

--query
SELECT
    ccl.CptCode AS CPTCode,
    ccl.CptGrouping AS CPTCodeDescription,
    ccl.CptDescription AS CPTCodeGroup
FROM
    CptCodesLookup ccl;


--ddl
CREATE TABLE dp_oltp_healthcare.DimCPTCode (
    cptcode varchar(10) NOT NULL,
    cptcodedescription varchar(255) NULL,
    cptcodegroup varchar(255) NULL,
    CONSTRAINT DimCPTCode_pkey PRIMARY KEY (cptcode)
);